<script>

    // collapsibles javascript

    const collapsiblesHeaders = document.querySelectorAll(".collapsible-item-header-content");
    collapsiblesHeaders.forEach(collapsiblesHeader => {
        collapsiblesHeader.addEventListener('click', event => {
            collapsiblesHeader.classList.toggle('active')
            const collapsiblesBody = collapsiblesHeader.parentElement.nextElementSibling;
            if (collapsiblesHeader.classList.contains("active")) {
                console.log(collapsiblesBody.scrollHeight)
                collapsiblesBody.style.maxHeight = collapsiblesBody.scrollHeight + "px";
            } else {
                collapsiblesBody.style.maxHeight = 0;
            }
        })
    })

    // filters javascript

    const filtersHeader = document.querySelector(".filters-header");
    filtersHeader.addEventListener('click', event => {
        filtersHeader.classList.toggle('active')
        const filtersBody = filtersHeader.nextElementSibling;
        if (filtersHeader.classList.contains("active")) {
            filtersBody.style.maxHeight = filtersBody.scrollHeight + "px";
        } else {
            filtersBody.style.maxHeight = 0;
        }
    })

    // Add comments

    let targetCommentButton
    let targetCommentBox
    let targetCollapisbleBody

    const commentsButtons = document.querySelectorAll(".comment-add-button");
    commentsButtons.forEach(commentButton => {
        commentButton.addEventListener('click', event => {
            targetCommentButton = event.target
            targetCollapisbleBody = targetCommentButton.parentElement.parentElement.parentElement.parentElement;
            const userId = targetCommentButton.dataset.userid
            targetCommentBox = commentButton.previousElementSibling.firstElementChild;
            const comment = targetCommentBox.value;
            const appendTo = targetCommentButton.parentElement.parentElement.getElementsByTagName('div')[0];
            if (comment.trim() != "") addCommentToDB({ userId, comment })
        })
    })

    function addCommentToDB({ userId, comment }) {
        google.script.run.withSuccessHandler(addCommentInPage).withFailureHandler(failedToAddComment).addComment({ userId, comment })
    }

    function addCommentInPage(HTMLContent) {
        const comments = targetCommentButton.parentElement.parentElement.getElementsByTagName('div')[0];
        if (comments.innerHTML == "No comments yet..") {
            comments.innerHTML = ""
            comments.insertAdjacentHTML('beforeend', HTMLContent)
        } else comments.insertAdjacentHTML('beforeend', HTMLContent)
        targetCommentBox.value = ""
        // targetCollapisbleBody.style.maxHeight = targetCollapisbleBody.scrollHeight + "px";
    }

    function failedToAddComment() {
        console.log("failed to add comment")
    }

    // Decide on Candidates

    let targetDecisionButton
    let isDecisionInitiallySelected
    let targetCollapisbleElement
    let buttonColors = {
        accept: {
            color: "green",
            fill: "lightgreen"
        },
        reject: {
            color: "red",
            fill: "pink"
        },
        defer: {
            color: "gold",
            fill: "#FFF380"
        },
    }

    const decisionButtons = document.querySelectorAll(".decision-button");

    decisionButtons.forEach(decisionButton => {
        decisionButton.addEventListener('click', event => {
            targetDecisionButton = event.target.closest('.decision-button-svg-container').parentElement;
            isDecisionInitiallySelected = targetDecisionButton.classList.contains("selected")
            targetCollapisbleElement = targetDecisionButton.parentElement.parentElement.parentElement.parentElement;
            const userId = targetDecisionButton.dataset.userid
            const decision = targetDecisionButton.dataset.decision
            toggleButtonsInCard();
            decideOnCandidate(userId, decision)
        })
    })

    function toggleButtonsInCard() {
        const allDecisionButtons = targetCollapisbleElement.querySelectorAll('.decision-button');
        allDecisionButtons.forEach(decisionButton => {
            removeIconSelected(decisionButton);
        })
        toggleButton()
    }

    function toggleButton(decisionButton) {
        decisionButton = decisionButton || targetDecisionButton
        console.log(targetDecisionButton)
        if (isDecisionInitiallySelected) removeIconSelected()
        else setIconSelected()
    }

    function removeIconSelected(decisionButton) {
        decisionButton = decisionButton || targetDecisionButton
        decisionButton.firstElementChild.firstElementChild.setAttribute("fill", "none");
        decisionButton.style.color = "black";
        decisionButton.classList.remove("selected");
    }

    function setIconSelected(decisionButton) {
        decisionButton = decisionButton || targetDecisionButton
        const decision = targetDecisionButton.dataset.decision;
        const { fill, color } = buttonColors[decision];
        decisionButton.firstElementChild.firstElementChild.setAttribute("fill", fill);
        decisionButton.style.color = color;
        decisionButton.classList.add("selected");
    }

    function decideOnCandidate(userId, decision) {
        //Google Script Run
        //On Success
    }

    function decisionRecorded(decision) {
        targetCollapisbleElement.classList.add('decided');
        targetCollapisbleElement.dataset.decision = decision;
    }


    function decisionNotRecorded() {
        targetCollapisbleElement.dataset.decision = "pending";
        removeIconSelected();
    }

    /*

    let filteringCriteria
    let paginationSize = 10;

    window.onload = applyFilters
    
    const applyFilters = function(){
        getFiltersFromLocalStorage()
        const {filteredInHTMLEntries, filterOutHTMLEntries} = applyFiltersToEntries()
        paginate(filteredInHTMLEntries, filterOutHTMLEntries)
    }

    const getFiltersFromLocalStorage = function(){
        const loadedCriteria = localStorage.getItem('filteringCriteria')
        if(!loadedCriteria) filteringCriteria = {}
        else filteringCriteria = JSON.parse(loadedCriteria);
    }

    const applyFiltersToEntries = function(){
        const htmlEntriesOfStage = getHTMLEntriesOfStage()
        return applyFiltersToHTNLEntries(htmlEntriesOfStage)
    }

    const getHTMLEntriesOfStage = function(){
        const stage = getCurrentStage(); // OR DO IT TO ALL STAGES SO DONT JUST GET CURRENT STAGE  BUT ALL STAGES AND LOOP
        const htmlEntriesOfStage = document.querySelectorAll('.collapsible').filter(HTMLElement=>HTMLElement.data.stage == stage)
        return htmlEntriesOfStage
    }

    const getCurrentStage = function(){
        const stage = document.querySelectorAll('.stages').filter(HTMLElement=>HTMLElement.classList.contains("active"))[0].value; //Get the active stage
        return stage
    }

    const applyFiltersToHTNLEntries = function(htmlEntriesOfStage){
        const filteredInHTMLEntries = []
        const filterOutHTMLEntries = []
        htmlEntriesOfStage.forEach(HTMLELement=>{
            filteringCriteria
        })
        return {filteredInHTMLEntries, filterOutHTMLEntries}
    }

    const paginate = function(filteredInHTMLEntries, filterOutHTMLEntries){
        clearStagesContainer()
        const hiddenPage = createHiddenPage(filterOutHTMLEntries)
        const visiblePages = createAllVisiblePages(filteredInHTMLEntries)
    }

    const createHiddenPage = function(filterOutHTMLEntries){
        const pageContainer = createPageContainer(0)
        pageContainer.innerHTML = filterOutHTMLEntries //TODO
        pageContainer.style.display = 'hidden';
    }

    const createAllVisiblePages = function(filteredInHTMLEntries){
        const segmentizedFilteredInHTMLEntries = segmentize(filteredInHTMLEntries)
        segmentizedFilteredInHTMLEntries.forEach((segment,i)=>{
            const pageNumber = i + 1;
            const pageContainer = createPageContainer(pageNumber);
            pageContainer.innerHTML = segment //TODO
            if(i == 0) pageContainer.classList.add('active');
        })

    }

    const segmentize = function(entries){
        //TODO
    }

    const createPageContainer = function(pageNumber){
        const createdHTMLElement = document.createHTMLELement()
        createdHTMLElement.classList.add('page-container');
        return createdHTMLElement;
    }

    */

</script>